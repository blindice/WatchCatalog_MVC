@model string

<div id="watchList-container" style="width: 100vw">
    <section id="search" style="height: 15vh; width: 100vw; display: flex; align-items: end; justify-content: center; padding: 0vh 6.5vw">
        <div style="flex-grow: 1;">
            <div class="input-group" style="width: 25%; align-self: end">
                <input type="text" class="form-control" id="searchInput" placeholder="Type to Search...">
                <button class="btn btn-outline-primary" type="button" id="btnClear">Clear</button>
            </div>
        </div>
        <button id="btnAdd" class="btn btn-primary" style="align-self: end">Create Watch</button>
    </section>
    <section id="watchList" style="width: 100%;padding: 6vh 6.5vw; min-height: 70vh">
        <div style="display: flex; flex-direction: column; width: 100%; min-height: 70vh; gap:2.5vw;">
            <div id="watchesContainer" style="display: flex; column-gap: 1.5vw;row-gap: 1vh; flex-wrap: wrap; font-family: 'Nunito', sans-serif; height: 100%">
            </div>
            <div id="pagination-container" style="align-self: center">
                <ul class="pagination">
                </ul>
            </div>
        </div>
    </section>
</div>

@section Scripts{
    <script>

        $(async () => {
            let getAllWatches = async (pageNumber = 1, pageSize = 10) => {
                let searchString = document.getElementById("searchInput").value;
                console.log(searchString)
                await $.ajax({
                    url: `@Url.Action("getwatches")?SearchString=${searchString}&PageNumber=${pageNumber}&PageSize=${pageSize}`,
                    method: "GET",
                    beforeSend: () => {
                        $("#watchesContainer").empty()
                        $(".pagination").empty()
                        $("#watchesContainer").html(createShimmers(pageSize))
                    },
                    success: (res) => {
                        //create watches cards
                        $("#watchesContainer").empty()

                        if (res.watchDTOs.length === 0) {
                            $("#watchesContainer").empty()
                            $(".pagination").empty()
                            $("#watchesContainer").html('<video autoplay loop muted playsinline src="/videos/empty-data.mp4" style="height: 50%; align-self: center; margin: auto"></video>')
                        }
                        else {
                            $.each(res.watchDTOs, (key, value) => {
                                let createCard = (value) => {
                                    if (value.isActive) {
                                        let card = $("<div>").addClass("card shadow-none").css("width", "16vw").css({ "height": "42vh", "cursor": "pointer", "border": "none" })
                                        let imgContainer = $("<div>").addClass("card-img-top shadow-sm").css("width", "100%").css({ "height": "75%", "position": "relative", "overflow": "hidden", "display": "flex", "justify-content": "center", "align-items": "center", "border-radius": "1vh" })
                                        let image = $(`<img src='${value.image}' />`).css("width", "100%").css("position", "absolute").css("margin", "auto")
                                        let cardBody = $("<div>").addClass("card-body").css({ "text-overflow": "ellipsis", "padding": "1vh .5vw", "position" : "relative" })
                                        let cardTitle = $("<p>").addClass("card-title text-truncate").text(value.watchName).css({ "font-weight": "700", "font-size": "1.5vh", "line-height": "1.5vh" })
                                        let cardDesc = $("<p>").addClass("card-text text-truncate").text(value.short_description).css({ "font-weight": "700", "font-size": "1.5vh", "line-height": "1.5vh" })
                                        let cardText = $("<p>").addClass("card-text").text(`Price: ฿ ${value.price}`).css({ "font-weight": "700", "font-size": "1.5vh", "line-height": "1vh" })
                                        let cardRate = createRandomRate();

                                        card.click(() => {
                                            window.location.href = `@Url.Action("Details")/${value.watchId}`
                                        })
                                        imgContainer.append(image)
                                        cardBody.append(cardTitle, cardDesc, cardText, cardRate)

                                        return card.append(imgContainer, cardBody)
                                    }
                                }
                                $("#watchesContainer").append(createCard(value))
                            })

                            // create pagination
                            $(".pagination").empty()
                            let firstPagination = $("<li>").addClass(`page-item ${res.hasPrevious ? '' : 'disabled'}`).wrapInner(`<button class='page-link'>First</button>`)

                            if (res.hasPrevious) firstPagination.click(async () => await getAllWatches(1))

                            let lastPagination = $("<li>").addClass(`page-item ${res.hasNext && res.currentPage != res.totalPage ? '' : 'disabled'}`)
                                .wrapInner(`<button class='page-link'>Last</button>`)

                            if (res.hasNext && res.currentPage != res.totalPage) lastPagination.click(async () => await getAllWatches(res.totalPages))

                            let paginationButtons = []

                            for (let i = res.currentPage - 2; i <= res.currentPage + 2; i++) {
                                let pageButton;
                                if (i > 0 && i <= res.totalPages)
                                    pageButton = $("<li>").addClass("page-item").wrapInner($("<button>").addClass("page-link").text(i).click(async () => await getAllWatches(i)))

                                if (i === res.currentPage)
                                    pageButton.addClass("active").children().off()

                                paginationButtons.push(pageButton)
                            }

                            $(".pagination").append(firstPagination, paginationButtons, lastPagination)
                        }
                    },
                    error: (xhr, ajaxOptions, thrownError) => {
                        console.log(xhr)
                        window.location = `/error?statusCode=${xhr.status}&message=${xhr.responseText}`;
                    }
                })
            }

            //search
            var xhr = null;
            var timeout = null;
            $("#searchInput").keyup(() => {
                clearTimeout(timeout);
                if (xhr != null)
                    xhr.abort();
                timeout = setTimeout(async function () {
                    xhr = await getAllWatches();
                }, 500);
            })

            $("#searchInput").val('@Model')
            $("#searchInput").trigger("keyup");

            //clear search
            $("#btnClear").click(() => {
                $("#searchInput").val('')
                $("#searchInput").trigger("keyup");
            })
        })
    </script>
}